#!/bin/bash
host=$1
user=$2
password=$3
auth=$2:$3
dat=webdata_now_p
val=W

# option check
if [ $# -lt 3 ]
then
  echo "Usage: $0 <host> <username> <password> [-t]"
  exit 1
fi
if [ $# -gt 3 ]
then
  dat=webdata_today_e
  val=kWh
fi
ping -c3 $host > /dev/null 2>&1
if [ $? -eq 0 ]
then
  p=$(curl -s -u "$auth" "$host"/status.html | grep "$dat = " | awk -F '"' '{print $2}')
  if [ "$p" = "" ]
  then
    sleep 1
    p=$(curl -s -u "$auth" "$host"/status.html | grep "$dat = " | awk -F '"' '{print $2}')
  fi
  if [ "$p" = "" ]
  then
    sleep 1
    p=$(curl -s -u "$auth" "$host"/status.html | grep "$dat = " | awk -F '"' '{print $2}')
  fi
  if [ "$p" = "" ]
  then
    sleep 1
    p=$(curl -s -u "$auth" "$host"/status.html | grep "$dat = " | awk -F '"' '{print $2}')
  fi
  if [ "$p" != "" ]
  then
    echo "$p $val"
    exit 0
  fi
  echo "Error: could not read data"
  exit 1
else
  echo "Error: connection to $host failed"
  exit 1
fi
